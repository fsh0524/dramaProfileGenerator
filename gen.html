<html>
	<head>
		<script type="text/javascript" src="javascript/fabric.min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>

	<body>
		<div style="height=150px; width=100%;">
			<label>上傳你的圖片： </label>
			<input type="file" id="imageLoader" name="imageLoader"/>
		</div>
		<br/>
		<canvas id="canvas" width="960" height="960"></canvas><br/>

		<a id="lnkDownload" class="gdbut" href="#">完成並下載！</a>
		
		<script>
			var canvas = new fabric.Canvas('canvas');
			canvas.setBackgroundImage('image/canvas/background.png', canvas.renderAll.bind(canvas), {
			  originX: 'left',
			  originY: 'top',
		    left: 0,
		    top: 0,
		    // crossOrigin: 'anonymous'
			});

			// var imageLoader = document.getElementById('imageLoader');
			// imageLoader.addEventListener('change', handleImage, false);
			// function handleImage(e) {
			//     var objects = canvas.getObjects();
			//     for (var i in objects) {
			//        objects[i].remove();
			//     }
			//     var reader = new FileReader();
			//     reader.onload = function (event) {
			//         var img = new Image();
			//         img.onload = function () {
			//             var imgInstance = new fabric.Image(img, {
			//                selectable: 1
			//             })
			//             canvas.add(imgInstance);
			//             canvas.deactivateAll().renderAll();
			//         }
			//         img.src = event.target.result;
			//     }
			//     reader.readAsDataURL(e.target.files[0]);
			// }

			fabric.Image.fromURL('image/canvas/show_image.jpeg', function(img) {
		    img.set( { left: 100, top: 100 } );
		    canvas.add(img);

		    var imageLoader = document.getElementById('imageLoader');
		    imageLoader.addEventListener('change', handleImage, false);
		    function handleImage(e){
			    var reader = new FileReader();
			    reader.onload = function(event){
			        var nimg = new Image();
			        nimg.onload = function() {
		            img.width = this.width;
		            img.height = this.height;
		            img.setSrc(this.src);
			        }
			        nimg.src = event.target.result;
			    }
			    reader.readAsDataURL(e.target.files[0]);     
				}

		  });

			var imageSaver = document.getElementById('lnkDownload');
			imageSaver.addEventListener('click', saveImage, false);

			function saveImage(e) {
			    this.href = canvas.toDataURL('png');
			    this.download = 'canvas.png';
			}

		</script>
	</body>

</html>